% basics
\usepackage{fontspec}
\setmonofont{Iosevka Nerd Font Propo}[Renderer=HarfBuzz]
\makeatletter
\def\ltj@stdmcfont{"Noto Serif CJK JP:style=Regular"} % luatexja requires this
\def\ltj@stdgtfont{"Noto Serif CJK JP:style=Medium"} % Otherwise it use HaranoAjiMincho defaultly
\makeatother
\usepackage{luatexja}
\usepackage[match]{luatexja-fontspec} % 'match' let \rmfamily, \textrm, \sffamily also change Japanese font family
\jfontspec[CJKShape=NLC]{Noto Serif CJK JP}
\setmainjfont{Noto Serif CJK JP}[% If you want to specify different fonts for a style
  Renderer=HarfBuzz%
  % BoldFont=*-Bold,
  % UprightFont=*-Regular
]
\setsansjfont{Noto Sans CJK JP}[Renderer=HarfBuzz]
\setmonojfont{Noto Sans Mono CJK JP}[Renderer=HarfBuzz]
\usepackage{luatexja-ruby}

\usepackage{setspace} % Change paragraph spacing
%\usepackage{pxrubrica} % Ruby annotations
\usepackage{url}
% \usepackage{hyperref}
% \hypersetup{
%     colorlinks,
%     linkcolor={black},
%     citecolor={black},
%     urlcolor={blue!80!black}
% }
\usepackage{graphicx}
\usepackage{float}
\usepackage{booktabs}
\usepackage{enumitem}
\setlist[enumerate]{leftmargin=!,labelindent=0pt,labelwidth=10pt,labelsep=2pt,itemindent=\labelwidth+\labelsep,listparindent=\parindent}
% Because the package enumitem has algorithm:
% leftmargin = labelindent + (labelwidth + labelsep) - itemindent.
% To make paragraph align with label, we need itemindent cancels the length of "labelwidth + lalbelsep", and labelindent = 0pt, so the leftmargin becomes 0pt
% A debug command \DrawEnumitemLabel draws 4 rules from top to bottom: labelindent, labelwidth, labelsep, itemindent.
% The * and ! value let the parameter calculate from the other parameters, while the ! will automatically set \labelwidth with a guessed value first.
 
% \usepackage{parskip}
\usepackage{emptypage}
\usepackage{subcaption}
\usepackage{multicol}
\usepackage[dvipsnames]{xcolor}

% \usepackage{cmbright}

\usepackage{amsmath, amsfonts, amssymb, mathtools, amsthm}
\usepackage{mathrsfs}
\usepackage{cancel}
\usepackage{bm}
\newcommand\N{\ensuremath{\mathbb{N}}}
\newcommand\R{\ensuremath{\mathbb{R}}}
\newcommand\Z{\ensuremath{\mathbb{Z}}}
\renewcommand\O{\ensuremath{\emptyset}}
\newcommand\Q{\ensuremath{\mathbb{Q}}}
\newcommand\C{\ensuremath{\mathbb{C}}}
\newcommand\dd{\mathrm{d}}
\newcommand\evalat[3][]{\left.#2\right\rvert_{#3}\ifthenelse{\isempty{#1}}{}{^#1}}
% \newcommand\evalat[2][]{\left.#2\right\rvert_{#3}^[]}
\DeclareMathOperator{\sgn}{sgn}
\DeclareMathOperator{\Ker}{ker}
\DeclareMathOperator{\im}{Im}
\let\svlim\lim\def\lim{\svlim\limits}
\let\implies\Rightarrow%
\let\impliedby\Leftarrow%
\let\iff\Leftrightarrow%
\let\epsilon\varepsilon%
\DeclarePairedDelimiter\abs{\lvert}{\rvert}
\DeclarePairedDelimiter\norm{\lVert}{\rVert}
\usepackage{stmaryrd} % for \lightning
\newcommand\contra{\scalebox{1.1}{$\lightning$}}
% \let\phi\varphi

% correct
\definecolor{correct}{HTML}{009900}
\newcommand\correct[2]{\ensuremath{\:}{\color{red}{#1}}\ensuremath{\to }{\color{correct}{#2}}\ensuremath{\:}}
\newcommand\green[1]{{\color{correct}{#1}}}

% horizontal rule
\newcommand\hr{\noindent\rule[0.5ex]{\linewidth}{0.5pt}}

% hide parts
\newcommand\hide[1]{}

% si unitx
\usepackage{siunitx}
\sisetup{locale = US}
% \renewcommand\vec[1]{\mathbf{#1}}
\newcommand\mat[1]{\mathbf{#1}}

% tikz
\usepackage{tikz}
\usepackage{tikz-cd}
\usetikzlibrary{intersections, angles, quotes, calc, positioning}
\usetikzlibrary{arrows.meta}
\usepackage{pgfplots}
\pgfplotsset{compat=1.18}
\tikzset{force/.style={thick,{Circle[length=2pt]}-stealth,shorten<=-1pt}}
\newcommand{\tikzmark}[2]{\tikz[overlay,remember picture,baseline] \node[anchor=base] (#1) {$#2$};}
\newcommand{\drawline}[3][]{%
  \begin{tikzpicture}[overlay,remember picture]
    \draw[#1] (#2) -- (#3);
  \end{tikzpicture}
}
\newcommand{\drawvline}[3][]{%
  \begin{tikzpicture}[overlay,remember picture]
    \draw[#1] (#2.north) -- (#3.south);
  \end{tikzpicture}
}
\newcommand{\drawhline}[3][]{%
  \begin{tikzpicture}[overlay,remember picture]
    \draw[#1] (#2.west) -- (#3.east);
  \end{tikzpicture}
}

\usepackage{geometry}
\geometry{a4paper,total={170mm,257mm},twoside}
% theorems
\usepackage{thmtools}
\usepackage[framemethod=TikZ]{mdframed}
\mdfsetup{skipabove=1em,skipbelow=0em}
\theoremstyle{definition}
\declaretheoremstyle[
  headfont=\bfseries\sffamily\color{ForestGreen!70!black}, bodyfont=\normalfont,
  mdframed={
    linewidth=2pt,
    rightline=false, topline=false, bottomline=false,
    linecolor=ForestGreen, backgroundcolor=ForestGreen!5,
  }
]{thmgreenbox}
\declaretheoremstyle[
  headfont=\bfseries\sffamily\color{NavyBlue!70!black}, bodyfont=\normalfont,
  mdframed={
    linewidth=2pt,
    rightline=false, topline=false, bottomline=false,
    linecolor=NavyBlue, backgroundcolor=NavyBlue!5,
  }
]{thmbluebox}
\declaretheoremstyle[
  headfont=\bfseries\sffamily\color{NavyBlue!70!black}, bodyfont=\normalfont,
  mdframed={
    linewidth=2pt,
    rightline=false, topline=false, bottomline=false,
    linecolor=NavyBlue
  }
]{thmblueline}
\declaretheoremstyle[
  headfont=\bfseries\sffamily\color{RawSienna!70!black}, bodyfont=\normalfont,
  mdframed={
    linewidth=2pt,
    rightline=false, topline=false, bottomline=false,
    linecolor=RawSienna, backgroundcolor=RawSienna!5,
  }
]{thmredbox}
\declaretheoremstyle[
  headfont=\bfseries\sffamily\color{RawSienna!70!black}, bodyfont=\normalfont,
  numbered=no,
  mdframed={
    linewidth=2pt,
    rightline=false, topline=false, bottomline=false,
    linecolor=RawSienna, backgroundcolor=RawSienna!1,
  },
  qed=\qedsymbol%
]{thmproofbox}
\declaretheoremstyle[
  headfont=\bfseries\sffamily\color{NavyBlue!70!black}, bodyfont=\normalfont,
  numbered=no,
  mdframed={
    linewidth=2pt,
    rightline=false, topline=false, bottomline=false,
    linecolor=NavyBlue, backgroundcolor=NavyBlue!1,
  },
]{thmexplanationbox}
\declaretheorem[style=thmgreenbox, name=Definition]{definition}
\declaretheorem[style=thmbluebox, numbered=no, name=Example]{eg}
\declaretheorem[style=thmredbox, name=Proposition]{prop}
\declaretheorem[style=thmredbox, name=Theorem]{theorem}
\declaretheorem[style=thmredbox, name=Lemma]{lemma}
\declaretheorem[style=thmredbox, numbered=no, name=Corollary]{corollary}
\declaretheorem[style=thmproofbox, name=Proof]{replacementproof}
\renewenvironment{proof}[1][]{%
  \vspace{-10pt}\ifthenelse{\isempty{#1}}{%
    \begin{replacementproof}%
  }{%
    \begin{replacementproof}[#1]%
  }%
}{\end{replacementproof}}
\declaretheorem[style=thmexplanationbox, name=Proof]{tmpexplanation}
\newenvironment{explanation}[1][]{\vspace{-10pt}\begin{tmpexplanation}}{\end{tmpexplanation}}
\declaretheorem[style=thmblueline, numbered=no, name=Remark]{remark}
\declaretheorem[style=thmblueline, numbered=no, name=Note]{note}
\newtheorem*{uovt}{UOVT}
\newtheorem*{notation}{Notation}
\newtheorem*{previouslyseen}{As previously seen}
\newtheorem*{problem}{Problem}
\newtheorem*{observe}{Observe}
\newtheorem*{property}{Property}
\newtheorem*{intuition}{Intuition}

\usepackage{etoolbox}
\AtEndEnvironment{vb}{\null\hfill$\diamond$}%
\AtEndEnvironment{intermezzo}{\null\hfill$\diamond$}%
% \AtEndEnvironment{opmerking}{\null\hfill$\diamond$}%

% http://tex.stackexchange.com/questions/22119/how-can-i-change-the-spacing-before-theorems-with-amsthm
\makeatletter
% \def\thm@space@setup{%
%   \thm@preskip=\parskip \thm@postskip=0pt
% }

\newcommand{\oefening}[1]{%
  \def\@oefening{#1}%
  \subsection*{Oefening #1}
}
\newcommand{\suboefening}[1]{%
  \subsubsection*{Oefening \@oefening.#1}
}
\newcommand{\exercise}[1]{%
  \def\@exercise{#1}%
  \subsection*{Exercise #1}
}
\newcommand{\subexercise}[1]{%
  \subsubsection*{Exercise \@exercise.#1}
}

\usepackage{xifthen}

\def\testdateparts#1{\dateparts#1\relax}
\def\dateparts#1 #2 #3 #4\relax{
  \marginpar{\scriptsize\textsf{\mbox{#1 #2 #3 #4}}}
}

\def\@lesson{}%
\newcommand{\lesson}[3]{
  \ifthenelse{\isempty{#3}}{%
    \def\@lesson{Lecture #1}%
  }{%
    \def\@lesson{Lecture #1: #3}%
  }%
  \subsection*{\@lesson}
  \testdateparts{#2}
}

% \renewcommand\date[1]{\marginpar{#1}}

% fancy headers
\usepackage{fancyhdr}
\pagestyle{fancy}

% \fancyhead[LE,RO]{Gilles Castel}
\fancyhead[RO,LE]{\@lesson}
\fancyhead[RE,LO]{}
\fancyfoot[LE,RO]{\thepage}
\fancyfoot[C]{\leftmark}

\makeatother
% notes
\usepackage{todonotes}
\usepackage{tcolorbox}
\tcbuselibrary{breakable}
\newenvironment{verbetering}{\begin{tcolorbox}[
  arc=0mm,
  colback=white,
  colframe=green!60!black,
  title=Opmerking,
  fonttitle=\sffamily,
  breakable
]}{\end{tcolorbox}}
\newenvironment{noot}[1]{\begin{tcolorbox}[
  arc=0mm,
  colback=white,
  colframe=white!60!black,
  title=#1,
  fonttitle=\sffamily,
  breakable
]}{\end{tcolorbox}}

% figure support
\usepackage{import}
\usepackage{pdfpages}
\newcommand{\incfig}[1]{%
  \def\svgwidth{\columnwidth}
  \import{./figures/}{#1.pdf_tex}
}
\author{Proteus Qian}
